"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function createDataEntryGrid(containerId,headers,newRowCount){var _rowCount=0;var _columnCount=0;var anchorRow=0;var anchorColumn=0;var selectionRow=0;var selectionColumn=0;var returnColumn=0;var inputBox=null;var contextMenu=null;var hiddenTextarea=null;var localizedText={deleteRow:"Delete row",addRowBefore:"Add row before",addRowAfter:"Add row after"};var undo=undoSystem();function noop(){return null}var commitEdit=noop;var table=document.getElementById(containerId);function getRow(r){return getTbody().getElementsByTagName("TR")[r]}function getCell(r,c){return getRow(r).getElementsByTagName("TD")[c]}function getAnchor(){return getCell(anchorRow,anchorColumn)}function getColumnHeaders(){var thead=table.getElementsByTagName("THEAD");if(thead.length===0){return[]}var ths=thead[0].getElementsByTagName("TH");var headers=[];for(var i=1;i!==ths.length;++i){headers.push(ths[i].textContent)}return headers}function refocus(){hiddenTextarea.focus()}function createElementArray(container,element,items,adaptFn){if(typeof container==="string"){container=document.createElement(container)}var size=items;var getItem=function getItem(index){return index};if(_typeof(items)==="object"){getItem=function getItem(index){return items[index]};size=items.length}for(var i=0;i!=size;++i){var sub=document.createElement(element);if(adaptFn){adaptFn(sub,getItem(i))}container.appendChild(sub)}return container}function createElement(tag,attributes){var e=document.createElement(tag);for(var k in attributes){e.setAttribute(k,attributes[k])}return e}function init(headers,rows){var data=[];if(_typeof(rows)==="object"){data=rows;rows=data.length}var thead=createElementArray("THEAD","TR",1,function(tr){createElementArray(tr,"TH",1,function(th){var div=createElement("DIV",{style:"width:0;height:0;overflow:hidden"});hiddenTextarea=createElement("TEXTAREA",{tabindex:"-1"});div.appendChild(hiddenTextarea);th.onclick=refocus;th.appendChild(div)});createElementArray(tr,"TH",headers,function(e,x){e.textContent=x;e.onclick=refocus})});var tbody=createElementArray("TBODY","TR",rows,function(tr,i){var rowData=data[i];var row=rowData?rowData:[];createElementArray(tr,"TH",1);createElementArray(tr,"TD",headers.length,function(td,j){if(j<row.length){td.textContent=row[j]}if(i===0&&j===0){td.setAttribute("class","anchor")}})});var oldTHeads=table.getElementsByTagName("THEAD");if(oldTHeads.length===0){table.appendChild(thead)}else{table.replaceChild(thead,oldTHeads[0])}var oldTBodies=table.getElementsByTagName("TBODY");if(oldTBodies.length===0){table.appendChild(tbody)}else{table.replaceChild(tbody,oldTBodies[0])}anchorRow=0;selectionRow=0;anchorColumn=0;selectionColumn=0;_rowCount=rows;_columnCount=headers.length;undo.clearUndo();setCellMouseHandlers(0);refocus()}function removeContextMenu(){if(contextMenu){table.removeChild(contextMenu);contextMenu=null}refocus()}function getMouseCoordinates(ev){if(ev.pageX||ev.pageY){return{x:ev.pageX,y:ev.pageY}}return{x:ev.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:ev.clientY+document.body.scrollTop+document.documentElement.scrollTop}}function preventDefault(ev){if(ev.preventDefault){ev.preventDefault()}if(ev.stopPropagation){ev.stopPropagation()}ev.cancelBubble=true;return false}function getEvent(ev){return ev?ev:window.event}function handleInputKey(ev){ev=getEvent(ev);if(ev.keyCode===9){if(ev.shiftKey){goToPreviousCell()}else{goToNextCell()}return preventDefault(ev)}else if(ev.keyCode===13){goToNextRow();return preventDefault(ev)}return true}function beginEdit(){var r=anchorRow;var c=anchorColumn;var maxLength=3;forEachRow(0,_rowCount,function(row){forEachColumn(row,c,c+1,function(cell){var len=cell.textContent.length;if(maxLength<len){maxLength=len}})});var box=createElement("INPUT",{size:maxLength-2});var cell=getCell(r,c);var text=cell.textContent;box.value=text;cell.textContent="";cell.appendChild(box);commitEdit=function commitEdit(){return doCommitEdit(r,c,box,text)};box.onkeydown=handleInputKey;box.onblur=function(){undo.undoable(commitEdit(r,c,box,text));refocus()};box.setSelectionRange(0,box.value.length);box.focus();inputBox=box}function doCommitEdit(row,column,box,oldValue){inputBox=null;commitEdit=noop;var newValue=box.value;if(box.parentNode===null){return null}putCells(row,row+1,column,column+1,[[newValue]]);if(oldValue===newValue){return null}return function(){return putCellsAction(row,row+1,column,column+1,[[oldValue]])}}function getTbody(){var tbodies=table.getElementsByTagName("TBODY");if(tbodies.length<1){throw"No tbodies in table!"}return tbodies[0]}function insertRows(r,count){undo.undoable(commitEdit());var tbody=getTbody();var insertFunction=r<_rowCount?function(child){tbody.insertBefore(child,getRow(r))}:function(child){tbody.appendChild(child)};for(var i=0;i!==count;++i){var row=createElementArray("TR","TH",1);createElementArray(row,"TD",_columnCount);insertFunction(row)}_rowCount+=count;var selectionEndsMoved=0;if(r<=anchorRow){selectionEndsMoved+=1;anchorRow+=count}if(r<=selectionRow){selectionEndsMoved+=1;selectionRow+=count}setCellMouseHandlers(r);if(selectionEndsMoved===1){forEachRow(r,r+count,markSelectedColumns)}return function(){return deleteRows(r,count)}}function deleteRows(r,count){undo.undoable(commitEdit());var values=getCells(r,r+count,0,_columnCount);var tbody=getTbody();for(var i=0;i!==count;++i){tbody.removeChild(tbody.children[r])}_rowCount-=count;if(r<anchorRow){if(r+count<anchorRow){anchorRow-=count}else{anchorRow=r}}if(r<selectionRow){if(r+count<selectionRow){selectionRow-=count}else{selectionRow=r}}if(_rowCount<=selectionRow){selectionRow=_rowCount-1}if(_rowCount<=anchorRow){anchorRow=_rowCount-1;_setSelection(anchorRow,anchorColumn,selectionRow,selectionColumn)}setCellMouseHandlers(r);return function(){var inverse=insertRows(r,count);putCells(r,r+count,0,_columnCount,values);return inverse}}function markSelectedColumns(row){forEachSelectedColumn(row,function(cell){cell.classList.add("selected")})}function _setSelection(aRow,aColumn,sRow,sColumn){getAnchor().classList.remove("anchor");forEachSelectedRow(function(row){forEachSelectedColumn(row,function(cell){cell.classList.remove("selected")})});anchorRow=aRow;anchorColumn=aColumn;selectionRow=sRow;selectionColumn=sColumn;forEachSelectedRow(function(row){markSelectedColumns(row)});getAnchor().classList.add("anchor")}function doGoToCell(r,c){undo.undoable(commitEdit());getAnchor().classList.remove("anchor");if(r<0||_rowCount<=r||c<0||_columnCount<=c){return}_setSelection(r,c,r,c);getAnchor().classList.add("anchor");beginEdit()}function goToNextRow(){if(_rowCount<=anchorRow+1){undo.undoable(insertRows(_rowCount,1))}doGoToCell(anchorRow+1,returnColumn)}function goToPreviousCell(){doGoToCell(anchorRow,anchorColumn-1)}function goToNextCell(){if(anchorColumn+1<_columnCount){doGoToCell(anchorRow,anchorColumn+1)}else{goToNextRow()}}function goToCell(r,c){returnColumn=c;doGoToCell(r,c)}function deleteRowsOption(count){var el=createElement("OPTION",{value:"delete"});el.textContent=localizedText.deleteRow;return el}function addRowsBeforeOption(count){var el=createElement("OPTION",{value:"add-before"});el.textContent=localizedText.addRowBefore;return el}function addRowsAfterOption(count){var el=createElement("OPTION",{value:"add-after"});el.textContent=localizedText.addRowAfter;return el}function rowHeaderMenu(ev,r){var firstRow=r;var count=1;if(r<anchorRow&&r<selectionRow||anchorRow<r&&selectionRow<r){_setSelection(r,0,r,_columnCount-1)}else{if(anchorRow<selectionRow){firstRow=anchorRow;count=selectionRow-anchorRow+1}else{firstRow=selectionRow;count=anchorRow-selectionRow+1}}var id=table.getAttribute("id").concat("-row-menu");contextMenu=createElement("SELECT",{id:id,size:3});var deleteOption=deleteRowsOption();deleteOption.onclick=function(){undo.undoable(deleteRows(firstRow,count));removeContextMenu()};contextMenu.appendChild(deleteOption);var addBeforeOption=addRowsBeforeOption();addBeforeOption.onclick=function(){undo.undoable(insertRows(firstRow,count));removeContextMenu()};contextMenu.appendChild(addBeforeOption);var addAfterOption=addRowsAfterOption();addAfterOption.onclick=function(){undo.undoable(insertRows(firstRow+count,count));removeContextMenu()};contextMenu.appendChild(addAfterOption);var mousePosition=getMouseCoordinates(ev);contextMenu.style.position="fixed";contextMenu.style.left=mousePosition.x+"px";contextMenu.style.top=mousePosition.y+"px";contextMenu.tabIndex=-1;contextMenu.zIndex=10;contextMenu.onblur=removeContextMenu;contextMenu.contentEditable=false;table.appendChild(contextMenu);return contextMenu}function forEachRow(rowStart,rowEnd,callback){var rows=getTbody().getElementsByTagName("TR");var rEnd=(rows.length<rowEnd?rows.length:rowEnd)-rowStart;for(var i=0;i<rEnd;++i){callback(rows[rowStart+i],i,rowStart+i)}}function forEachColumn(row,columnStart,columnEnd,callback){var cs=row.getElementsByTagName("TD");var cEnd=(cs.length<columnEnd?cs.length:columnEnd)-columnStart;for(var i=0;i<cEnd;++i){callback(cs[columnStart+i],i,columnStart+i)}}function forEachSelectedRow(callback){forEachRow(Math.min(anchorRow,selectionRow),Math.max(anchorRow,selectionRow)+1,callback)}function forEachSelectedColumn(row,callback){forEachColumn(row,Math.min(anchorColumn,selectionColumn),Math.max(anchorColumn,selectionColumn)+1,callback)}function setCellMouseHandlers(firstRow){forEachRow(firstRow,_rowCount,function(row,i,thisRow){var rowHeaders=row.getElementsByTagName("TH");if(0<rowHeaders.length){var rh=rowHeaders[0];rh.textContent=thisRow+1;rh.onclick=refocus;rh.oncontextmenu=function(ev){ev=getEvent(ev);var select=rowHeaderMenu(ev,thisRow);select.focus();return preventDefault(ev)};forEachColumn(row,0,_columnCount,function(cell,j,thisColumn){cell.onclick=function(){goToCell(thisRow,thisColumn)};cell.onmouseenter=function(ev){ev=getEvent(ev);if(ev.buttons&1){_setSelection(anchorRow,anchorColumn,thisRow,thisColumn);refocus();return preventDefault(ev)}};cell.onmousedown=function(ev){ev=getEvent(ev);if(ev.button===0){undo.undoable(commitEdit());_setSelection(thisRow,thisColumn,thisRow,thisColumn);refocus();return preventDefault(ev)}}})}})}function getCellContents(cell){var inputs=cell.getElementsByTagName("INPUT");if(0<inputs.length){return inputs[0].value}return cell.textContent}function withDefault(a,def){return typeof a==="undefined"?def:a}function getCells(rowStart,rowEnd,columnStart,columnEnd){var vss=[];forEachRow(withDefault(rowStart,0),withDefault(rowEnd,_rowCount),function(row){var vs=[];forEachColumn(row,withDefault(columnStart,0),withDefault(columnEnd,_columnCount),function(cell){vs.push(getCellContents(cell))});vss.push(vs)});return vss}function putCells(rowStart,rowEnd,columnStart,columnEnd,values){forEachRow(rowStart,rowEnd,function(row,i){var vr=values[i];forEachColumn(row,columnStart,columnEnd,function(cell,j){cell.textContent=typeof vr==="undefined"?"":vr[j]})})}function putCellsAction(rowStart,rowEnd,columnStart,columnEnd,values){var oldValues=getCells(rowStart,rowEnd,columnStart,columnEnd);putCells(rowStart,rowEnd,columnStart,columnEnd,values);_setSelection(rowStart,columnStart,rowEnd-1,columnEnd-1);return function(){return putCellsAction(rowStart,rowEnd,columnStart,columnEnd,oldValues)}}function doUndo(){undo.undoable(commitEdit());undo.undo();refocus()}function doRedo(){commitEdit();undo.redo();refocus()}function clearCells(startRow,endRow,startColumn,endColumn){var row=[];for(var i=startColumn;i!==endColumn;++i){row.push("")}var empties=[];for(var j=startRow;j!==endRow;++j){empties.push(row)}undo.undoable(putCellsAction(startRow,endRow,startColumn,endColumn,empties))}function clearSelection(){var firstRow=Math.min(anchorRow,selectionRow);var lastRow=Math.max(anchorRow,selectionRow)+1;var firstColumn=Math.min(anchorColumn,selectionColumn);var lastColumn=Math.max(anchorColumn,selectionColumn)+1;clearCells(firstRow,lastRow,firstColumn,lastColumn)}function copySelection(){var texts=[];forEachSelectedRow(function(row){var rowTexts=[];forEachSelectedColumn(row,function(cell){var inputs=cell.getElementsByTagName("INPUT");if(0<inputs.length){rowTexts.push(inputs[0].value)}else{rowTexts.push(cell.textContent)}});texts.push(rowTexts.join("\t"))});return texts.join("\n")}function paste(clip){if(clip.length===0){return}var values=[];var maxRowLength=0;var lines=clip.split("\n");if(lines[lines.length-1].length===0){lines.pop()}for(var i=0;i!==lines.length;++i){var row=lines[i].split("\t");values.push(row);if(maxRowLength<row.length){maxRowLength=row.length}}var firstRow=Math.min(anchorRow,selectionRow);var lastRow=Math.max(anchorRow,selectionRow)+1;var firstColumn=Math.min(anchorColumn,selectionColumn);var lastColumn=Math.max(anchorColumn,selectionColumn)+1;if(lastColumn<firstColumn+maxRowLength){lastColumn=firstColumn+maxRowLength}if(lastRow<firstRow+values.length){lastRow=firstRow+values.length;if(_rowCount<lastRow){undo.undoable(insertRows(_rowCount,lastRow-_rowCount))}}for(var c=firstColumn+maxRowLength;c<lastColumn;++c){var source=c%maxRowLength;for(var r=0;r!==values.length;++r){values[r][c-firstColumn]=values[r][source]}}var valueRowCount=values.length;var wantedRowCount=lastRow-firstRow;for(var _r=valueRowCount;_r<wantedRowCount;++_r){values[_r]=values[_r%valueRowCount]}undo.undoable(putCellsAction(firstRow,lastRow,firstColumn,lastColumn,values))}function tableKeyPressHandler(ev){ev=getEvent(ev);if(contextMenu){return}if(!inputBox){beginEdit();var cc=ev.charCode||ev.keyCode;if(31<cc){inputBox.value=String.fromCharCode(cc)}return preventDefault(ev)}}function tableCutHandler(ev){ev=getEvent(ev);var text=copySelection();ev.clipboardData.setData("text/plain",text);clearSelection();refocus();return preventDefault(ev)}function tableCopyHandler(ev){ev=getEvent(ev);var text=copySelection();ev.clipboardData.setData("text/plain",text);return preventDefault(ev)}function tablePasteHandler(ev){ev=getEvent(ev);if(0<=ev.clipboardData.types.indexOf("text/plain")){try{paste(ev.clipboardData.getData("text/plain"))}catch(err){console.log(err)}}refocus();return preventDefault(ev)}function tableKeyDownHandler(ev){ev=getEvent(ev);if(contextMenu){if(ev.key==="Escape"){refocus()}if(ev.key==="Enter"||ev.key===" "){var index=contextMenu.selectedIndex;if(0<=index){var options=contextMenu.getElementsByTagName("option");options[index].onclick();return preventDefault(ev)}}return}if((ev.ctrlKey||ev.metaKey)&&!ev.altKey){if(ev.keyCode===90){if(ev.shiftKey){doRedo()}else{doUndo()}return preventDefault(ev)}}if(ev.key==="Delete"||ev.key==="Backspace"){clearSelection();return preventDefault(ev)}if(moveSelection(ev)===false){return preventDefault(ev)}if(moveAnchor(ev)===false){return preventDefault(ev)}}function moveAnchor(ev){if(ev.shiftKey||ev.altKey||ev.metaKey){return}var inputNotSelected=inputBox&&inputBox.selectionStart===inputBox.selectionEnd;var inputAtStart=inputNotSelected&&inputBox.selectionStart===0;var inputAtEnd=inputNotSelected&&inputBox.selectionStart===inputBox.value.length;if(ev.key==="ArrowLeft"){if(inputBox&&!inputAtStart){return}if(0<anchorColumn){undo.undoable(commitEdit());_setSelection(anchorRow,anchorColumn-1,anchorRow,anchorColumn-1);returnColumn=anchorColumn;beginEdit()}return false}if(ev.key==="ArrowRight"){if(inputBox&&!inputAtEnd){return}if(anchorColumn+1<_columnCount){undo.undoable(commitEdit());_setSelection(anchorRow,anchorColumn+1,anchorRow,anchorColumn+1);returnColumn=anchorColumn;beginEdit()}return false}var dest=move(ev,anchorRow,anchorColumn);if(dest){undo.undoable(commitEdit());_setSelection(dest.row,dest.column,dest.row,dest.column);beginEdit();return false}}function move(ev,row,column){var here={row:row,column:column};if(ev.key==="ArrowUp"){if(0<row){return{row:row-1,column:column}}return here}if(ev.key==="ArrowDown"){if(row+1<_rowCount){return{row:row+1,column:column}}return here}if(ev.key==="ArrowLeft"){if(0<column){return{row:row,column:column-1}}return here}if(ev.key==="ArrowRight"){if(column+1<_columnCount){return{row:row,column:column+1}}return here}if(ev.key==="Home"){return ev.ctrlKey?{row:0,column:0}:{row:row,column:0}}if(ev.key==="End"){column=_columnCount-1;return ev.ctrlKey?{row:_rowCount-1,column:column}:{row:row,column:column}}if(ev.key==="PageUp"){return{row:Math.max(0,row-rowsVisibleCount()),column:column}}if(ev.key==="PageDown"){return{row:Math.min(_rowCount-1,row+rowsVisibleCount()),column:column}}return null}function rowsVisibleCount(){var pixelsToScrollPast=Math.max(0,window.innerHeight-1);var rowPixels=Math.max(getAnchor().offsetHeight,1);return Math.floor(pixelsToScrollPast/rowPixels+1)}function moveSelection(ev){if(!ev.shiftKey||ev.altKey||ev.metaKey){return}var dest=move(ev,selectionRow,selectionColumn);if(dest){_setSelection(anchorRow,anchorColumn,dest.row,dest.column);return false}}function clampRow(r){return r<0?0:_rowCount<=r?_rowCount-1:r}function clampColumn(c){return c<0?0:_columnCount<=c?_columnCount-1:c}table.onkeydown=tableKeyDownHandler;table.onkeypress=tableKeyPressHandler;table.oncut=tableCutHandler;table.oncopy=tableCopyHandler;table.onpaste=tablePasteHandler;table.onmousemove=function(ev){ev=getEvent(ev);if(ev.buttons&1){return preventDefault(ev)}};table.onmousedown=function(ev){ev=getEvent(ev);if(ev.button===0){return preventDefault(ev)}};init(headers,newRowCount);refocus();return{init:init,setText:function setText(newText){for(var k in localizedText){if(k in newText){localizedText[k]=newText[k]}}},setButtons:function setButtons(undoButton,redoButton){undo.setButtons(undoButton,redoButton,refocus)},getSelection:function getSelection(){return{anchorRow:anchorRow,anchorColumn:anchorColumn,selectionRow:selectionRow,selectionColumn:selectionColumn}},setSelection:function setSelection(anchorRow,anchorColumn,selectionRow,selectionColumn){_setSelection(clampRow(anchorRow),clampColumn(anchorColumn),clampRow(withDefault(selectionRow,anchorRow)),clampColumn(withDefault(selectionColumn,anchorColumn)))},rowCount:function rowCount(){return _rowCount},columnCount:function columnCount(){return _columnCount},getColumnHeaders:getColumnHeaders,goToCell:goToCell,getCells:getCells,putCells:function putCells(rowStart,rowEnd,columnStart,columnEnd,values){undo.undoable(putCellsAction(rowStart,rowEnd,columnStart,columnEnd,values))},clearData:function clearData(){clearCells(0,_rowCount,0,_columnCount)},getColumn:function getColumn(column){var vs=[];forEachRow(0,_rowCount,function(row){forEachColumn(row,column,column+1,function(cell){vs.push(getCellContents(cell))})});return vs},clearUndo:function clearUndo(){return undo.clearUndo()},undo:function undo(){return doUndo()},redo:function redo(){return doRedo()}}};
"use strict";function undoSystem(){var undoStack=[];var redoStack=[];var undoButton=null;var redoButton=null;function undoable(action){if(action!==null){if(redoButton&&redoStack.length!==0){redoButton.setAttribute("disabled","")}if(undoButton&&undoStack.length===0){undoButton.removeAttribute("disabled")}undoStack.push(action);redoStack=[]}}function redo(){if(redoStack.length!==0){var action=redoStack.pop()();if(redoButton&&redoStack.length===0){redoButton.setAttribute("disabled","")}if(action!==null){if(undoButton&&undoStack.length===0){undoButton.removeAttribute("disabled")}undoStack.push(action)}}}function undo(){if(undoStack.length!==0){var action=undoStack.pop()();if(undoButton&&undoStack.length===0){undoButton.setAttribute("disabled","")}if(action!==null){if(redoButton&&redoStack.length===0){redoButton.removeAttribute("disabled")}redoStack.push(action)}}}function clearUndo(){if(redoButton&&redoStack.length!==0){redoButton.setAttribute("disabled","")}if(undoButton&&undoStack.length!==0){undoButton.setAttribute("disabled","")}redoStack=[];undoStack=[]}function setButtons(anUndoButton,aRedoButton,afterFn){undoButton=anUndoButton;redoButton=aRedoButton;if(undoButton){undoButton.onclick=afterFn?function(){undo();afterFn()}:undo;if(undoStack.length===0){undoButton.setAttribute("disabled","")}else{undoButton.removeAttribute("disabled")}}if(redoButton){redoButton.onclick=afterFn?function(){redo();afterFn()}:redo;if(redoStack.length===0){redoButton.setAttribute("disabled","")}else{redoButton.removeAttribute("disabled")}}}return{undoable:undoable,setButtons:setButtons,clearUndo:clearUndo,undo:undo,redo:redo}};
